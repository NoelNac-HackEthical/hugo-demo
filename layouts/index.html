{{ define "main" }}
<main id="main" class="home-min">
  {{ $pages := where .Site.RegularPages "Type" "in" (slice "posts" "post" "writeups") }}
  {{ $p := .Paginate $pages }}

  <ul class="post-list">
    {{ range $p.Pages }}
      {{ $cover := .Resources.GetMatch "image.png" }}
      {{ if not $cover }}{{ $cover = .Resources.GetMatch "image.jpg" }}{{ end }}
      {{ if not $cover }}{{ $cover = .Resources.GetMatch "image.jpeg" }}{{ end }}
      {{ if not $cover }}
        {{ $imgs := .Resources.ByType "image" }}
        {{ if gt (len $imgs) 0 }}{{ $cover = index $imgs 0 }}{{ end }}
      {{ end }}

      {{ $page := . }} {{/* capture de la page avant le with $cover */}}

      <li class="post-item">
        <h2 class="post-title">
          <a href="{{ $page.RelPermalink | relURL }}" aria-label="Ouvrir {{ $page.Title }}">{{ $page.Title }}</a>
        </h2>

        <div class="post-meta">
          Publié le {{ $page.Date | time.Format ":date_long" }}
          {{ if ne ($page.Lastmod.Format "2006-01-02") ($page.Date.Format "2006-01-02") }}
            et modifié le {{ $page.Lastmod | time.Format ":date_long" }}
          {{ end }}
        </div>

        <div class="summary-image-row">
          <p class="post-summary">
            {{ with $page.Params.summary }}{{ . }}{{ else }}{{ $page.Summary | plainify | truncate 180 }}{{ end }}
          </p>

          {{ with $cover }}
            {{ $thumb     := .Fill "120x120 center" }}
            {{ $thumbWebp := .Fill "120x120 center webp" }}
            <a class="thumb-wrap" href="{{ $page.RelPermalink | relURL }}" aria-label="Ouvrir {{ $page.Title }}">
              <picture>
                <source srcset="{{ $thumbWebp.RelPermalink }}" type="image/webp">
                <img
                  src="{{ $thumb.RelPermalink }}"
                  alt="Writeup {{ $page.Title }}"
                  loading="lazy"
                  decoding="async"
                  width="{{ $thumb.Width }}"
                  height="{{ $thumb.Height }}">
              </picture>
            </a>
          {{ end }}
        </div>

        {{ with $page.Params.tags }}
        <div class="post-tags">
          {{ range . }}
            <a href="{{ (printf "/tags/%s/" (urlize .)) | relURL }}" class="tag">#{{ . }}</a>
          {{ end }}
        </div>
        {{ end }}
      </li>
    {{ end }}
  </ul>

  {{ if gt $p.TotalPages 1 }}
  <nav class="pager">
    {{ if $p.HasPrev }}<a href="{{ $p.Prev.URL | relURL }}">← Plus récents</a>{{ end }}
    <span>Page {{ $p.PageNumber }} / {{ $p.TotalPages }}</span>
    {{ if $p.HasNext }}<a href="{{ $p.Next.URL | relURL }}">Plus anciens →</a>{{ end }}
  </nav>
  {{ end }}
</main>

<style>
  .home-min { max-width: 860px; margin: 0 auto; padding: 1rem; }
  .post-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 1.0rem; }
  .post-item { border-bottom: 1px solid var(--border, rgba(127,127,127,.25)); padding-bottom: 1rem; }
  .post-title { font-size: 1.2rem; margin: 0 0 .25rem; }
  .post-title a { text-decoration: none; }
  .post-meta { font-size: .9rem; opacity: .8; margin-bottom: .35rem; }
  .post-summary { margin: 0; }

  .summary-image-row { display: flex; align-items: flex-start; gap: .75rem; margin-top: .25rem; }

  /* Vignette carrée 120x120 */
  .thumb-wrap { display: block; border-radius: 10px; overflow: hidden; flex-shrink: 0; width: 120px; height: 120px; }
  .thumb-wrap img { display: block; width: 100%; height: 100%; object-fit: cover; }

  /* ===== Tags ===== */
  .post-tags { display: flex; flex-wrap: wrap; gap: .4rem; margin-top: .4rem; }

  /* Variables de base */
  :root {
    --border: rgba(127,127,127,.25);

    /* Mode clair: normal */
    --tag-fg: #1E90FF;
    --tag-bg: rgba(127,127,127,.15);

    /* Mode clair: hover souhaité */
    --tag-fg-hover-light: #003366;           /* bleu foncé (gras via font-weight) */
    --tag-bg-hover-light: rgba(127,127,127,.40); /* un peu plus sombre que normal */
  }
  html.dark, body.dark {
    --border: rgba(255,255,255,.15);

    /* Mode sombre: normal */
    --tag-fg: #9ecbff;
    --tag-bg: rgba(255,255,255,.15);

    /* Mode sombre: hover souhaité */
    --tag-fg-hover-dark: #ffffff;            /* blanc */
    --tag-bg-hover-dark: rgba(255,255,255,.30); /* plus clair */
  }

  .post-tags .tag {
    font-size: .85rem;
    font-weight: bold;
    text-decoration: none;
    color: var(--tag-fg);
    background-color: var(--tag-bg);
    padding: .08rem .4rem;
    border-radius: 999px;
    transition: color .2s ease, background-color .2s ease, box-shadow .2s ease;
    outline: none;
  }

  /* Hover CLAIR (seulement quand .dark n’est pas présent) */
  html:not(.dark) .post-tags .tag:hover,
  html:not(.dark) .post-tags .tag:focus-visible {
    color: var(--tag-fg-hover-light) !important;        /* texte bleu foncé */
    background-color: var(--tag-bg-hover-light) !important; /* fond un peu plus sombre */
  }

  /* Hover SOMBRE (seulement quand .dark est présent) */
  html.dark .post-tags .tag:hover,
  html.dark .post-tags .tag:focus-visible,
  body.dark .post-tags .tag:hover,
  body.dark .post-tags .tag:focus-visible {
    color: var(--tag-fg-hover-dark) !important;        /* texte blanc */
    background-color: var(--tag-bg-hover-dark) !important; /* fond plus clair */
  }

  /* Pager */
  .pager { display: flex; gap: .75rem; justify-content: center; margin-top: 1rem; }

  @media (max-width: 720px) {
    .summary-image-row { flex-direction: column; }
    .thumb-wrap { width: 100%; max-width: 240px; height: auto; aspect-ratio: 1 / 1; }
  }
</style>
{{ end }}
