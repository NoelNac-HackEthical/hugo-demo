{{- $repo  := .Get "repo"  | default "NoelNac-HackEthical/mes-scripts" -}}
{{- $name  := .Get "name"  -}}
{{- $label := .Get "label" | default $name -}}

{{- if not $name -}}
  <div>Missing parameter <code>name</code> for gh_asset shortcode.</div>
{{- else -}}
  {{- $api := printf "https://api.github.com/repos/%s/releases/latest" $repo -}}

  {{- $token := getenv "HUGO_GITHUB_TOKEN" -}}
  {{- $headers := cond (ne $token "") (dict "Authorization" (printf "Bearer %s" $token)) (dict) -}}

  {{- $remote := resources.GetRemote $api (dict "headers" $headers) -}}
  {{- if not $remote -}}
    <div>Unable to fetch latest release from GitHub.</div>
  {{- else -}}
    {{- $json := $remote | transform.Unmarshal -}}
    {{- $assets := index $json "assets" | default (slice) -}}

    {{- $aScriptSlice := first 1 (where $assets "name" "eq" $name) -}}
    {{- $aScript := cond (gt (len $aScriptSlice) 0) (index $aScriptSlice 0) nil -}}

    {{- $aHashSlice := first 1 (where $assets "name" "eq" (print $name ".sha256")) -}}
    {{- $aHash := cond (gt (len $aHashSlice) 0) (index $aHashSlice 0) nil -}}

    {{- if not $aScript -}}
      <div>Asset <code>{{ $name }}</code> not found in latest release.</div>
    {{- else -}}
      <p>
        <strong>Dernière release :</strong> <code>{{ $json.tag_name }}</code><br>
        <a href="{{ $aScript.browser_download_url }}">⬇ Télécharger {{ $label }}</a>
        {{- if $aHash -}} &nbsp;|&nbsp;
          <a href="{{ $aHash.browser_download_url }}">SHA256</a>
        {{- end -}}
      </p>
    {{- end -}}
  {{- end -}}
{{- end -}}
