{{ define "main" }}
<article class="post-single" itemscope itemtype="http://schema.org/Article">
  <header class="post-header">
    <h1 class="post-title" itemprop="headline">{{ .Title }}</h1>
    {{ partial "post-meta.html" . }}
  </header>

  <div class="post-content" itemprop="articleBody">

    {{/* === Résumé + vignette 120×120 (comme sur la home) === */}}
    {{ if or .Params.summary (gt (len .Summary) 0) }}
      {{/* Image du bundle : cover.image -> thumb* -> image* -> 1re image */}}
      {{- $img := (and .Params.cover.image (.Resources.GetMatch .Params.cover.image)) -}}
      {{- if not $img }}{{ $img = .Resources.GetMatch "thumb*" }}{{ end -}}
      {{- if not $img }}{{ $img = .Resources.GetMatch "image*" }}{{ end -}}
      {{- if not $img -}}
        {{- $imgs := .Resources.ByType "image" -}}
        {{- if gt (len $imgs) 0 }}{{ $img = index $imgs 0 }}{{ end -}}
      {{- end -}}

      {{/* smart crop pour éviter le “trop bas / coupé” */}}
      {{- $thumb := $img -}}
      {{- $thumbWebp := $img -}}
      {{- if $img -}}
        {{- $thumb = $img.Fill "120x120 smart" -}}
        {{- $thumbWebp = $img.Fill "120x120 smart webp" -}}
      {{- end -}}

      <div class="summary-image-row">
        <p class="post-summary">
          {{ with .Params.summary }}{{ . }}{{ else }}{{ .Summary | plainify | truncate 180 }}{{ end }}
        </p>

        {{ with $thumb }}
          <div class="thumb-wrap" aria-label="Vignette {{ $.Title }}">
            <picture>
              {{ with $thumbWebp }}<source srcset="{{ .RelPermalink }}" type="image/webp">{{ end }}
              <img
                src="{{ $thumb.RelPermalink }}"
                alt="Vignette {{ $.Title }}"
                loading="lazy" decoding="async"
                width="{{ $thumb.Width }}" height="{{ $thumb.Height }}">
            </picture>
          </div>
        {{ end }}
      </div>
    {{ end }}

    {{/* === Contenu principal (inclut ta tagsline placée en haut du corps) === */}}
    {{ .Content }}

    {{/* === TOC PaperMod : on l’insère APRÈS le contenu pour ne pas couper le résumé/tags.
          Ton CSS la place de toute façon à droite (sticky). === */}}
    {{ if (.Param "ShowToc") }}
      {{ .TableOfContents }}
    {{ end }}

    {{/* === Navigation précédent/suivant (section writeups) === */}}
    <nav class="post-nav">
      {{ with .PrevInSection }}
        <a class="prev" href="{{ .RelPermalink }}" aria-label="Article précédent">← {{ .Title }}</a>
      {{ end }}
      {{ with .NextInSection }}
        <a class="next" href="{{ .RelPermalink }}" aria-label="Article suivant">{{ .Title }} →</a>
      {{ end }}
    </nav>

  </div>
</article>
{{ end }}
