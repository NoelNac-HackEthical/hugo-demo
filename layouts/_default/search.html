{{ define "main" }}
<main id="main" class="search-page">
  <header class="page-header">
    <h1>Recherche</h1>
  </header>

  <input type="search" id="searchInput" placeholder="Tape ta recherche..." autofocus>

  <div id="searchStats" class="search-stats"></div>
  <div id="searchResults" class="search-results"></div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("searchInput");
    const resultsEl = document.getElementById("searchResults");
    const statsEl = document.getElementById("searchStats");
    let index = [];

    // Charger l'index JSON
    fetch("{{ "index.json" | relURL }}")
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(data => { index = data; })
      .catch(err => {
        statsEl.textContent = `Erreur de chargement de l’index : ${err.message}`;
      });

    function escapeHtml(str) {
      return str.replace(/[&<>'"]/g, tag =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[tag] || tag)
      );
    }

    input.addEventListener("input", function () {
      const query = input.value.trim();
      resultsEl.innerHTML = "";
      statsEl.textContent = "";

      if (!query) return;

      const terms = query.replace(/"([^"]+)"/g, (_, p1) => p1)
                         .split(/\s+/)
                         .filter(Boolean)
                         .map(t => t.toLowerCase());

      let totalOccurrences = 0;
      const matches = [];

      index.forEach((page, pageIndex) => {
        let occurrences = 0;
        let snippets = [];

        const haystack = (page.content || "").toLowerCase();

        terms.forEach(term => {
          let pos = haystack.indexOf(term);
          while (pos !== -1) {
            occurrences++;
            const start = Math.max(0, pos - 30);
            const end = Math.min(page.content.length, pos + term.length + 30);
            const snippet = escapeHtml(page.content.slice(start, end))
              .replace(new RegExp(`(${term})`, "gi"), "<mark>$1</mark>");
            snippets.push(snippet);
            pos = haystack.indexOf(term, pos + term.length);
          }
        });

        if (occurrences > 0) {
          totalOccurrences += occurrences;
          matches.push({
            title: page.title,
            relPermalink: page.relpermalink,
            snippets: snippets,
            count: occurrences
          });
        }
      });

      if (matches.length > 0) {
        statsEl.textContent = `${totalOccurrences} occurrence(s) dans ${matches.length} page(s)`;
        matches.forEach(match => {
          const div = document.createElement("div");
          div.className = "search-result";

          const link = document.createElement("a");
          link.href = `${match.relPermalink}?highlight=${encodeURIComponent(query)}&highlightIndex=0`;
          link.innerHTML = `<strong>${escapeHtml(match.title)}</strong> (${match.count})`;

          div.appendChild(link);

          match.snippets.forEach((snippet, i) => {
            const snippetDiv = document.createElement("div");
            snippetDiv.className = "snippet";
            snippetDiv.innerHTML = snippet;
            snippetDiv.addEventListener("click", () => {
              window.location.href = `${match.relPermalink}?highlight=${encodeURIComponent(query)}&highlightIndex=${i}`;
            });
            div.appendChild(snippetDiv);
          });

          resultsEl.appendChild(div);
        });
      } else {
        statsEl.textContent = "Aucun résultat trouvé.";
      }
    });
  });
  </script>

  <style>
    .search-stats { margin: 0.5em 0; font-style: italic; }
    .search-result { margin-bottom: 1.2em; }
    .snippet { font-size: 0.9em; color: var(--secondary); cursor: pointer; }
    .snippet mark { background: #fffd8a; }
    input[type="search"] {
      width: 100%; padding: 0.5em; font-size: 1em;
      box-sizing: border-box;
    }
  </style>
</main>
{{ end }}
