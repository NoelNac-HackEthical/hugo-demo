{{- define "main" -}}
<main id="main" class="max-w-3xl mx-auto px-4 py-10">
  <h1 class="text-4xl font-bold mb-6">{{ .Title | default "Recherche" }}</h1>

  <input
    id="search-input"
    type="search"
    placeholder='{{ site.Params.searchPlaceholder | default "Rechercher..." }}'
    class="w-full text-lg px-4 py-3 rounded border"
    autocomplete="off"
  />

  <div id="search-results" class="mt-8 space-y-6"></div>
</main>

{{/* charger Fuse.js depuis le thème PaperMod */}}
{{- $fuse := resources.Get "js/fuse.basic.min.js" | fingerprint -}}
<script defer src="{{ $fuse.RelPermalink }}"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const input = document.getElementById('search-input');
  const resultsEl = document.getElementById('search-results');

  const indexUrl = "{{ "index.json" | relURL }}";
  let pages = [];
  try {
    const r = await fetch(indexUrl, { cache: 'no-store' });
    pages = await r.json();
  } catch {
    resultsEl.innerHTML = "<p>Impossible de charger l’index.</p>";
    return;
  }

  // Moteurs Fuse
  const fuseExact = new window.Fuse(pages, {
    includeMatches: true, useExtendedSearch: true, ignoreLocation: true, minMatchCharLength: 1,
    keys: [{name:"title",weight:.2},{name:"tags",weight:.2},{name:"summary",weight:.6},{name:"content",weight:.8}]
  });
  const fuseFuzzy = new window.Fuse(pages, {
    includeMatches: true, threshold: 0.3, ignoreLocation: true, minMatchCharLength: 1,
    keys: [{name:"title",weight:.4},{name:"tags",weight:.3},{name:"summary",weight:.5},{name:"content",weight:.6}]
  });

  const fmtDate = (iso) => {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
  };

  // extrait basé sur indices Fuse (priorité content/summary)
  const makeSnippetFromMatches = (matches, radius = 40) => {
    if (!matches || !matches.length) return "";
    const m = matches.find(x => x.key === "content") || matches.find(x => x.key === "summary") || matches[0];
    if (!m?.value || !m.indices?.length) return "";
    const text = m.value.replace(/\s+/g, " ");
    const [s, e] = m.indices[0];
    const start = Math.max(0, s - radius);
    const end   = Math.min(text.length, e + 1 + radius);
    const before = (start > 0 ? "…" : "") + text.slice(start, s);
    const hit    = text.slice(s, e + 1);
    const after  = text.slice(e + 1, end) + (end < text.length ? "…" : "");
    return `${before}<strong style="color:gold;">${hit}</strong>${after}`;
  };

  // extrait manuel si Fuse ne donne pas d'indices
  const makeManualSnippet = (item, term, radius = 40) => {
    const text = (item.content || item.summary || "").replace(/\s+/g," ");
    const hay = text.toLowerCase();
    const needle = term.toLowerCase();
    const i = hay.indexOf(needle);
    if (i === -1) return "";
    const start = Math.max(0, i - radius);
    const end   = Math.min(text.length, i + term.length + radius);
    const before = (start > 0 ? "…" : "") + text.slice(start, i);
    const hit    = text.slice(i, i + term.length);
    const after  = text.slice(i + term.length, end) + (end < text.length ? "…" : "");
    return `${before}<strong style="color:gold;">${hit}</strong>${after}`;
  };

  const buildExactPattern = (q) => q.split(/\s+/).filter(Boolean).map(t => `'${t}`).join(' ');
  const sanitize = (q) => q.replace(/[^0-9A-Za-zÀ-ÖØ-öø-ÿ._\- ]+/g, " ").trim();

  const render = (items, termForManual = "") => {
    if (!items.length) { resultsEl.innerHTML = "<p>Aucun résultat.</p>"; return; }
    resultsEl.innerHTML = items.map(({ item, matches }) => {
      let snippet = makeSnippetFromMatches(matches, 40);
      if (!snippet && termForManual) snippet = makeManualSnippet(item, termForManual, 40);
      const date = fmtDate(item.date || item.lastmod);
      const tags = (item.tags || []).map(t => `<span class="tag">#${t}</span>`).join(" ");
      return `
        <article class="search-hit">
          <h3 class="hit-title"><a href="${item.permalink}">${item.title}</a></h3>
          ${date || tags ? `<div class="hit-meta">${[date, tags].filter(Boolean).join(" · ")}</div>` : ""}
          ${snippet ? `<p class="hit-snippet">${snippet}</p>` : ""}
        </article>
      `;
    }).join("");
  };

  input.addEventListener('input', (e) => {
    const q = e.target.value.trim();
    if (q.length < 2) { resultsEl.innerHTML = ""; return; }

    // 1) exact avec requête brute
    let found = fuseExact.search(buildExactPattern(q)).slice(0, 50);

    // 2) si rien, exact avec requête nettoyée
    const qSan = sanitize(q);
    if (!found.length && qSan) {
      found = fuseExact.search(buildExactPattern(qSan)).slice(0, 50);
    }

    // 3) si rien, fuzzy avec requête nettoyée
    if (!found.length && qSan) {
      found = fuseFuzzy.search(qSan).slice(0, 50);
    }

    render(found, qSan || q); // sert au manuel snippet si besoin
  });
});
</script>

<style>
/* lisible en dark/light mode via variables PaperMod */
#search-input { color: var(--content); background: var(--theme); border: 1px solid var(--border); caret-color: var(--content); }
#search-input::placeholder { color: var(--secondary); opacity: .85; }
.search-hit .hit-title { font-size: 1.15rem; margin: 0 0 .25rem 0; }
.search-hit .hit-meta { opacity:.75; font-size:.95rem; margin-bottom:.35rem; }
.search-hit .hit-snippet { margin:0; line-height:1.5; }
.tag { font-size:.85rem; opacity:.85; margin-right:.35rem; white-space:nowrap; }
</style>
{{- end -}}
