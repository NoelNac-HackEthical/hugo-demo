{{- define "main" -}}
<main id="main" class="max-w-3xl mx-auto px-4 py-10">
  <h1 class="text-4xl font-bold mb-6">{{ .Title | default "Recherche" }}</h1>

  <input
    id="search-input"
    type="search"
    placeholder='{{ site.Params.searchPlaceholder | default "Rechercher..." }}'
    class="w-full text-lg px-4 py-3 rounded border"
    autocomplete="off"
  />

  <div id="search-results" class="mt-8 space-y-6"></div>
</main>

{{/* Charge Fuse.js depuis les assets du thème PaperMod */}}
{{- $fuse := resources.Get "js/fuse.basic.min.js" | fingerprint -}}
<script defer src="{{ $fuse.RelPermalink }}"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const input = document.getElementById('search-input');
  const resultsEl = document.getElementById('search-results');

  // Charger l'index JSON (généré par Hugo)
  const indexUrl = "{{ "index.json" | relURL }}";
  let pages = [];
  try {
    const res = await fetch(indexUrl, { cache: 'no-store' });
    pages = await res.json();
  } catch {
    resultsEl.innerHTML = "<p>Impossible de charger l’index.</p>";
    return;
  }

  // Configuration Fuse.js
  const fuse = new window.Fuse(pages, {
    includeMatches: true,
    threshold: 0.3,
    ignoreLocation: true,
    minMatchCharLength: 2,
    keys: [
      { name: "title",   weight: 0.6 },
      { name: "tags",    weight: 0.4 },
      { name: "summary", weight: 0.3 },
      { name: "content", weight: 0.2 }
    ]
  });

  const fmtDate = (iso) => {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
  };

  // Extrait contextuel : ~40 caractères avant/après, avec le terme en gras + jaune
  const makeSnippet = (matches, term) => {
    if (!matches || !term) return "";
    term = term.trim();
    for (let m of matches) {
      if (!m.value) continue;
      const text = m.value.replace(/\s+/g, " ");
      const idx = text.toLowerCase().indexOf(term.toLowerCase());
      if (idx === -1) continue;
      const start = Math.max(0, idx - 40);
      const end   = Math.min(text.length, idx + term.length + 40);
      const before = (start > 0 ? "…" : "") + text.slice(start, idx);
      const hit    = text.slice(idx, idx + term.length);
      const after  = text.slice(idx + term.length, end) + (end < text.length ? "…" : "");
      return `${before}<strong style="background:yellow;">${hit}</strong>${after}`;
    }
    return "";
  };

  const render = (items, term) => {
    if (!items.length) { resultsEl.innerHTML = "<p>Aucun résultat.</p>"; return; }
    const html = items.map(({ item, matches }) => {
      const snippet = makeSnippet(matches, term);
      const date = fmtDate(item.date || item.lastmod);
      const tags = (item.tags || []).map(t => `<span class="tag">#${t}</span>`).join(" ");
      return `
        <article class="search-hit">
          <h3 class="hit-title"><a href="${item.permalink}">${item.title}</a></h3>
          ${date || tags ? `<div class="hit-meta">${[date, tags].filter(Boolean).join(" · ")}</div>` : ""}
          ${snippet ? `<p class="hit-snippet">${snippet}</p>` : ""}
        </article>
      `;
    }).join("");
    resultsEl.innerHTML = html;
  };

  input.addEventListener('input', (e) => {
    const q = e.target.value.trim();
    if (q.length < 2) { resultsEl.innerHTML = ""; return; }
    const term = q.split(/\s+/)[0]; // on met en avant le 1er mot saisi
    const found = fuse.search(q).slice(0, 50);
    render(found, term);
  });
});
</script>

<style>
/* lisibilité en dark mode (PaperMod) */
#search-input { color: var(--content); background: var(--theme); border: 1px solid var(--border); caret-color: var(--content); }
#search-input::placeholder { color: var(--secondary); opacity: .85; }

/* style des résultats */
.search-hit .hit-title { font-size: 1.15rem; margin: 0 0 .25rem 0; }
.search-hit .hit-meta { opacity:.75; font-size:.95rem; margin-bottom:.35rem; }
.search-hit .hit-snippet { margin:0; line-height:1.5; }
.tag { font-size:.85rem; opacity:.85; margin-right:.35rem; white-space:nowrap; }
</style>
{{- end -}}
