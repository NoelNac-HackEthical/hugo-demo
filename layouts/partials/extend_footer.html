{{/* layouts/partials/extend_footer.html
     - Charge highlight.js via Hugo Pipes (minify + SRI)
     - Émet 'postcontent-ready' quand la page est prête
     - Filet : recentre l’occurrence active si besoin
     NOTE : aucun déplacement de TOC ici (on s’appuie sur le wrapper d’origine)
*/}}

{{- $hl := resources.Get "js/highlight.js" | resources.Minify | resources.Fingerprint -}}
<script defer src="{{ $hl.RelPermalink }}" integrity="{{ $hl.Data.Integrity }}"></script>

<script>
  (function(){
    function fireReady(){ try { window.dispatchEvent(new Event('postcontent-ready')); } catch(e){} }
    if (document.readyState === 'complete') {
      fireReady();
    } else {
      window.addEventListener('load', fireReady, { once:true });
    }
    // BFCache (retour arrière/avant)
    window.addEventListener('pageshow', function (ev) {
      if (ev.persisted) fireReady();
    });
  })();
</script>

<script>
  (function(){
    function recenter(){
      const t = document.querySelector('mark.__hl-target');
      if (t) { t.scrollIntoView({ behavior:'smooth', block:'center' }); return true; }
      return false;
    }
    function retry(n){
      if (recenter()) return;
      if (n < 12) setTimeout(function(){ retry(n+1); }, 120); // ~1.5s max
    }
    function kick(){
      const p = new URLSearchParams(location.search);
      if (p.has('highlight')) retry(0);
    }
    window.addEventListener('postcontent-ready', kick);
  })();
</script>

