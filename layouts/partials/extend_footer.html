{{/* Charge le script de surlignage avancé via Hugo Pipes (minify + SRI) */}}
{{- $hl := resources.Get "js/highlight.js" | resources.Minify | resources.Fingerprint -}}
<script defer src="{{ $hl.RelPermalink }}" integrity="{{ $hl.Data.Integrity }}"></script>

<script>
(function(){
  function placeTOCAndSync(){
    const content = document.querySelector(".post-content");
    if (!content) return;

    // --- TOC à droite (layout 2 colonnes) ---
    const tocId = document.getElementById("TableOfContents");
    const tocWrapper = tocId ? tocId.closest(".toc") : null;
    let toc = tocWrapper || tocId || document.querySelector("aside.toc, details.toc, .toc");
    if (toc){
      let col = content.querySelector(":scope > .content-col");
      if (!col) {
        col = document.createElement("div");
        col.className = "content-col";
        Array.from(content.children).forEach(ch => {
          if (ch === toc || ch.id === "TableOfContents" || ch.classList?.contains("toc")) return;
          col.appendChild(ch);
        });
        content.innerHTML = "";
        content.appendChild(col);
        content.appendChild(toc);
      } else if (!content.contains(toc)) {
        content.appendChild(toc);
      }
      // Nettoyage des doublons éventuels hors .post-content
      document.querySelectorAll("aside.toc, details.toc, .toc, #TableOfContents").forEach(el => {
        if (!content.contains(el)) { try { el.remove(); } catch(e){} }
      });
      document.querySelectorAll("summary, .toc-title, h1,h2,h3,h4,h5,h6").forEach(el => {
        const t = (el.textContent||"").trim().toLowerCase();
        if (/^sommaire$|^table of contents$|^contents$/.test(t) && !content.contains(el)) {
          try { el.remove(); } catch(e){}
        }
      });
    }
    content.classList.add("toc-ready");

    // --- Respecter une ancre explicite (#id) en priorité ---
    const hash = decodeURIComponent(location.hash || "").replace(/^#/, "");
    if (hash) {
      const target = document.getElementById(hash);
      if (target) {
        target.scrollIntoView({behavior:"instant", block:"start"});
        setTimeout(()=> target.scrollIntoView({behavior:"smooth", block:"start"}), 60);
      }
    }

    // --- Si on vient de /search/ avec ?highlight=..., re-scroll vers l’occurrence surlignée ---
    const params = new URLSearchParams(location.search);
    if (params.has('highlight')) {
      // Laisse le temps à highlight.js (defer) de poser ses <mark>
      setTimeout(()=>{
        const current = document.querySelector('mark.__hl-target') || document.querySelector('mark.__hl');
        if (current) current.scrollIntoView({behavior:"smooth", block:"center"});
      }, 120);
    }

    // Notifier les scripts “post-content” (filet de sécurité)
    window.dispatchEvent(new Event("postcontent-ready"));
    setTimeout(()=> window.dispatchEvent(new Event('hashchange')), 100);
  }

  // Lancer APRÈS le chargement complet (highlight.js déjà exécuté en "defer")
  window.addEventListener('load', placeTOCAndSync);
  // Retour depuis le cache d’historique (BFCache)
  window.addEventListener('pageshow', (ev)=> { if (ev.persisted) placeTOCAndSync(); });
})();
</script>





