{{ define "main" }}
<main class="main">
  <article class="post-single">
    <header class="post-header">
      <h1>{{ .Title }}</h1>
      {{ partial "post-meta.html" . }}

      {{/* ===== Description (front matter) en box centrée ===== */}}
      {{ with .Params.description }}
        <div class="usage-box" style="text-align:center;">
          <p>{{ . | safeHTML }}</p>
        </div>
      {{ end }}

      {{/* ===== Ligne version dynamique ===== */}}
      {{ partial "components/versionline.html" . }}

      {{/* ===== Pastilles de tags ===== */}}
      {{ partial "components/tags.html" . }}
    </header>

    {{/* ================== Préparation du contenu ================== */}}
    {{ $content := .Content }}

    {{/* ---------- Construire la version normalisée (vX.Y.Z) ---------- */}}
    {{ $script := or .Params.script_file .Title }}
    {{ $verRaw := "" }}
    {{ with .Params.version }}
      {{/* trouve le premier 1.2.3 ou v1.2.3 dans la chaîne version */}}
      {{ $m := findRE `\bv?([0-9]+\.[0-9]+\.[0-9]+(?:[-+][A-Za-z0-9\.\-]+)?)\b` . }}
      {{ if $m }}{{ $verRaw = index $m 0 }}{{ end }}
    {{ end }}
    {{ $ver := "" }}
    {{ if $verRaw }}
      {{/* si le match ne commence pas par 'v', on le préfixe pour affichage */}}
      {{ $ver = cond (hasPrefix $verRaw "v") $verRaw (printf "v%s" $verRaw) }}
    {{ end }}

    {{/* phrase cible : "La version courante du script <script> est <ver>" */}}
    {{ $versionLine := "" }}
    {{ if and $script $ver }}
      {{ $versionLine = printf "La version courante du script %s est %s" $script $ver }}
    {{ end }}

    {{ if $versionLine }}
      {{/* Remplacer les formes anciennes/variantes dans le contenu Markdown */}}
      {{/* 1) "La version courante du script est <whatever>" */}}
      {{ $content = replaceRE `(?m)^\s*La version courante du script est .*?\r?\n` (printf "%s\n" $versionLine) $content }}

      {{/* 2) "La version courante du script <nom> est <whatever>" (nom peut être un token) */}}
      {{ $content = replaceRE `(?m)^\s*La version courante du script [^\r\n]+ est .*?\r?\n` (printf "%s\n" $versionLine) $content }}

      {{/* 3) au cas où la phrase est collée sans saut de ligne final (rare) */}}
      {{ $content = replaceRE `(?m)La version courante du script[^\r\n]*` (printf "%s" $versionLine) $content }}
    {{ end }}

    {{/* 2) Si la description a été recopiée dans le contenu, l'enlever */}}
    {{ with .Params.description }}
      {{ $content = replace $content . "" }}
    {{ end }}

    {{/* 3) Injection du bloc Usage sur <!-- USAGE --> */}}
    {{ with .Params.usage }}
      {{ $usage := . | replace "\r\n" "\n" | htmlEscape }}
      {{ $box := printf `
<div class="usage-box">
  <div class="usage-title">Usage</div>
  <pre class="usage-pre"><code>%s</code></pre>
</div>` $usage }}
      {{ $content = replaceRE `(?s)<!--\s*USAGE\s*-->` $box $content }}
    {{ end }}

    {{/* ================== Rendu du contenu ================== */}}
    <div class="post-content no-cols">
      {{ $content | safeHTML }}
    </div>

    {{/* (Footer catégories retiré) */}}

    <nav class="post-nav" style="margin-top:1.25rem; display:flex; justify-content:space-between; gap:1rem;">
      <div class="prev">{{ with .PrevInSection }}← <a href="{{ .RelPermalink }}">{{ .Title }}</a>{{ end }}</div>
      <div class="next">{{ with .NextInSection }}<a href="{{ .RelPermalink }}">{{ .Title }}</a> →{{ end }}</div>
    </nav>
  </article>
</main>
{{ end }}
